"""
ğŸ·ï¸ ××¢×¨×›×ª ×ª×’×™×•×ª ×•× ×™×§×•×“ ××ª×§×“××ª
Tag System with Smart Scoring
"""

# ============================================================
# ×”×’×“×¨×•×ª ×ª×’×™×•×ª ×¢× × ×™×§×•×“
# ============================================================

OCCASION_TAGS = {
    "××©×œ×•×— ×× ×•×ª": {
        "keywords": ["××©×œ×•×— ×× ×•×ª", "×¤×•×¨×™×", "×©×œ×— ×× ×•×ª", "purim"],
        "preferred_categories": ["snacks", "candy", "chocolate", "cookies"],
        "score_boost": 50,
        "must_have_kosher": True,
        "avoid": ["wine", "coffee", "spirits"]
    },
    "×—× ×•×›×”": {
        "keywords": ["×—× ×•×›×”", "×—×’ ×”××•×¨×™×", "chanukah", "hanukkah"],
        "preferred_categories": ["chocolate", "wine", "accessories", "cookies"],
        "score_boost": 40,
        "must_have_kosher": True
    },
    "×¨××© ×”×©× ×”": {
        "keywords": ["×¨××© ×”×©× ×”", "×©× ×” ×˜×•×‘×”", "×¨\"×”", "rosh hashanah"],
        "preferred_categories": ["wine", "honey", "chocolate", "dried_fruits"],
        "score_boost": 45,
        "must_have_kosher": True
    },
    "×™×•× ×”×•×œ×“×ª": {
        "keywords": ["×™×•× ×”×•×œ×“×ª", "×™×•××•×œ×“×ª", "birthday", "×‘×™×¨×ª'×“×™×™"],
        "preferred_categories": ["chocolate", "wine", "candy", "accessories"],
        "score_boost": 30
    },
    "×—×ª×•× ×”": {
        "keywords": ["×—×ª×•× ×”", "× ×™×©×•××™×Ÿ", "wedding"],
        "preferred_categories": ["wine", "accessories", "spirits"],
        "score_boost": 40,
        "style_preference": ["luxury", "elegant"]
    }
}

RECIPIENT_TAGS = {
    "×™×œ×“×™×": {
        "keywords": ["×™×œ×“", "×™×œ×“×™×", "×™×œ×“×”", "×‘×Ÿ", "×‘×ª", "kids", "children"],
        "preferred_categories": ["candy", "chocolate", "snacks"],
        "score_boost": 40,
        "avoid": ["wine", "coffee", "spirits"]
    },
    "× ×©×™×": {
        "keywords": ["××™×©×”", "×××", "××—×•×ª", "×—×‘×¨×”", "women", "woman"],
        "preferred_categories": ["chocolate", "wine", "tea"],
        "score_boost": 30
    },
    "×’×‘×¨×™×": {
        "keywords": ["×’×‘×¨", "××‘×", "××—", "×—×‘×¨", "men", "man"],
        "preferred_categories": ["wine", "coffee", "spirits"],
        "score_boost": 30
    },
    "××©×¤×—×”": {
        "keywords": ["××©×¤×—×”", "family", "×”×•×¨×™×"],
        "preferred_categories": ["snacks", "chocolate", "wine", "cookies"],
        "score_boost": 30,
        "variety_important": True
    }
}

STYLE_TAGS = {
    "×›×™×¤×™": {
        "keywords": ["×›×™×£", "×›×™×¤×™", "fun", "×¦×¢×™×¨", "××”× ×”"],
        "preferred_categories": ["snacks", "candy", "chocolate"],
        "score_boost": 35
    },
    "×™×•×§×¨×ª×™": {
        "keywords": ["×™×•×§×¨×ª×™", "luxury", "××¤× ×§", "×™×•×§×¨×”", "××§×¡×§×œ×•×¡×™×‘×™"],
        "preferred_categories": ["wine", "spirits", "chocolate"],
        "score_boost": 30
    },
    "×‘×¨×™×": {
        "keywords": ["×‘×¨×™×", "healthy", "×“×™××˜×”", "fit", "××•×¨×’× ×™"],
        "preferred_categories": ["nuts", "dried_fruits", "tea"],
        "score_boost": 30,
        "avoid": ["candy", "chocolate"]
    }
}

FOOD_PREFERENCE_TAGS = {
    "×—×˜×™×£": {
        "keywords": ["×—×˜×™×£", "×—×˜×™×¤×™×", "snack", "× ×©× ×•×©"],
        "categories": ["snacks"],
        "score_boost": 45,
        "occasions_boost": {
            "××©×œ×•×— ×× ×•×ª": 25
        }
    },
    "×©×•×§×•×œ×“": {
        "keywords": ["×©×•×§×•×œ×“", "chocolate", "×§×§××•"],
        "categories": ["chocolate"],
        "score_boost": 40,
        "occasions_boost": {
            "××©×œ×•×— ×× ×•×ª": 20
        }
    },
    "×××ª×§×™×": {
        "keywords": ["×××ª×§", "×××ª×§×™×", "candy", "×¡×•×›×¨×™×•×ª"],
        "categories": ["candy", "sweets"],
        "score_boost": 40,
        "occasions_boost": {
            "××©×œ×•×— ×× ×•×ª": 25
        }
    },
    "×™×™×Ÿ": {
        "keywords": ["×™×™×Ÿ", "wine", "××œ×›×•×”×•×œ"],
        "categories": ["wine"],
        "score_boost": 35
    },
    "×¢×•×’×™×•×ª": {
        "keywords": ["×¢×•×’×™×”", "×¢×•×’×™×•×ª", "cookies", "×‘×™×¡×§×•×•×™×˜"],
        "categories": ["cookies"],
        "score_boost": 35,
        "occasions_boost": {
            "××©×œ×•×— ×× ×•×ª": 20
        }
    }
}

DIETARY_TAGS = {
    "×›×©×¨": {
        "keywords": ["×›×©×¨", "kosher", "×›×©×¨×•×ª"],
        "required_attribute": "kosher",
        "is_mandatory": True
    },
    "×˜×‘×¢×•× ×™": {
        "keywords": ["×˜×‘×¢×•× ×™", "vegan", "×¦××—×•× ×™"],
        "required_attribute": "vegan",
        "is_mandatory": True
    },
    "×œ×œ× ×’×œ×•×˜×Ÿ": {
        "keywords": ["×œ×œ× ×’×œ×•×˜×Ÿ", "gluten free", "celiac"],
        "required_attribute": "gluten-free",
        "is_mandatory": True
    }
}

# ============================================================
# ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
# ============================================================

def extract_tags_from_text(user_text: str) -> dict:
    """
    ××—×œ×¥ ×ª×’×™×•×ª ××˜×§×¡×˜ ×—×•×¤×©×™ ×©×œ ×”××©×ª××©
    """
    text_lower = user_text.lower()
    
    extracted = {
        'occasion': None,
        'recipient': None,
        'style': None,
        'food_preferences': [],
        'dietary': []
    }
    
    # ×—×¤×© ××™×¨×•×¢
    for occasion, info in OCCASION_TAGS.items():
        for keyword in info['keywords']:
            if keyword.lower() in text_lower:
                extracted['occasion'] = occasion
                break
        if extracted['occasion']:
            break
    
    # ×—×¤×© × ××¢×Ÿ
    for recipient, info in RECIPIENT_TAGS.items():
        for keyword in info['keywords']:
            if keyword.lower() in text_lower:
                extracted['recipient'] = recipient
                break
        if extracted['recipient']:
            break
    
    # ×—×¤×© ×¡×’× ×•×Ÿ
    for style, info in STYLE_TAGS.items():
        for keyword in info['keywords']:
            if keyword.lower() in text_lower:
                extracted['style'] = style
                break
        if extracted['style']:
            break
    
    # ×—×¤×© ×”×¢×“×¤×•×ª ××–×•×Ÿ (×™×›×•×œ ×œ×”×™×•×ª ×›××”!)
    for food_pref, info in FOOD_PREFERENCE_TAGS.items():
        for keyword in info['keywords']:
            if keyword.lower() in text_lower:
                if food_pref not in extracted['food_preferences']:
                    extracted['food_preferences'].append(food_pref)
                break
    
    # ×—×¤×© ×“×¨×™×©×•×ª ×ª×–×•× ×”
    for dietary, info in DIETARY_TAGS.items():
        for keyword in info['keywords']:
            if keyword.lower() in text_lower:
                if dietary not in extracted['dietary']:
                    extracted['dietary'].append(dietary)
                break
    
    return extracted


def calculate_product_score(product: dict, extracted_tags: dict) -> tuple:
    """
    ××—×©×‘ ×¦×™×•×Ÿ ×”×ª×××” ××¤×•×¨×˜ ×œ××•×¦×¨
    Returns: (score, reasons)
    """
    score = 0
    reasons = []
    
    # 1. ×‘×“×™×§×ª ×“×¨×™×©×•×ª ×ª×–×•× ×” - ×§×¨×™×˜×™!
    for dietary in extracted_tags.get('dietary', []):
        dietary_info = DIETARY_TAGS.get(dietary, {})
        if dietary_info.get('is_mandatory'):
            required = dietary_info.get('required_attribute')
            product_dietary = product.get('dietary', '').lower()
            
            if required not in product_dietary:
                return 0, [f"âŒ ×œ× {dietary}"]
            else:
                reasons.append(f"âœ… {dietary}")
    
    # 2. ××™×¨×•×¢ - ×¦×™×•×Ÿ ×’×‘×•×”!
    occasion = extracted_tags.get('occasion')
    if occasion:
        occasion_info = OCCASION_TAGS.get(occasion, {})
        
        # ×‘×“×•×§ ×× ×‘×¢××•×“×” occasions
        product_occasions = product.get('occasions', '').lower()
        if occasion.lower() in product_occasions or any(kw.lower() in product_occasions for kw in occasion_info.get('keywords', [])):
            score += occasion_info.get('score_boost', 0)
            reasons.append(f"ğŸ‰ ××•×©×œ× ×œ-{occasion}")
            
            # ×‘×“×•×§ ×‘×•× ×•×¡ ×¡×¤×¦×™×¤×™ ×‘×¢××•×“×”
            if occasion == "××©×œ×•×— ×× ×•×ª" and product.get('mishloach_manot_score', 0) > 0:
                bonus = product.get('mishloach_manot_score', 0)
                score += bonus
                reasons.append(f"ğŸ’ ×‘×•× ×•×¡ ××©×œ×•×— ×× ×•×ª: +{bonus}")
        
        # ×‘×“×•×§ ×§×˜×’×•×¨×™×” ××ª××™××”
        elif product.get('category') in occasion_info.get('preferred_categories', []):
            base = occasion_info.get('score_boost', 0) // 2
            score += base
            reasons.append(f"ğŸ¯ ×§×˜×’×•×¨×™×” ××ª××™××” ×œ-{occasion}")
        
        # ×§× ×¡ ×¢×œ ×§×˜×’×•×¨×™×•×ª ×œ× ××ª××™××•×ª
        if product.get('category') in occasion_info.get('avoid', []):
            score -= 30
            reasons.append(f"âš ï¸ ×œ× ××ª××™× ×œ-{occasion}")
    
    # 3. × ××¢×Ÿ
    recipient = extracted_tags.get('recipient')
    if recipient:
        recipient_info = RECIPIENT_TAGS.get(recipient, {})
        product_recipients = product.get('recipients', '').lower()
        
        if recipient.lower() in product_recipients:
            score += recipient_info.get('score_boost', 0)
            reasons.append(f"ğŸ‘¤ ××ª××™× ×œ-{recipient}")
        elif product.get('category') in recipient_info.get('preferred_categories', []):
            score += recipient_info.get('score_boost', 0) // 2
    
    # 4. ×¡×’× ×•×Ÿ
    style = extracted_tags.get('style')
    if style:
        style_info = STYLE_TAGS.get(style, {})
        product_styles = product.get('styles', '').lower()
        
        if style.lower() in product_styles:
            score += style_info.get('score_boost', 0)
            reasons.append(f"âœ¨ ×‘×¡×’× ×•×Ÿ {style}")
    
    # 5. ×”×¢×“×¤×•×ª ××–×•×Ÿ - ×¢× ×‘×•× ×•×¡×™×!
    for food_pref in extracted_tags.get('food_preferences', []):
        food_info = FOOD_PREFERENCE_TAGS.get(food_pref, {})
        
        if product.get('category') in food_info.get('categories', []):
            base_score = food_info.get('score_boost', 0)
            score += base_score
            
            # ×‘×•× ×•×¡ × ×•×¡×£ ×× ×™×© ××™×¨×•×¢ ××ª××™×!
            if occasion:
                occasion_bonus = food_info.get('occasions_boost', {}).get(occasion, 0)
                if occasion_bonus > 0:
                    score += occasion_bonus
                    reasons.append(f"ğŸ’ {food_pref} ××•×©×œ× ×œ-{occasion}!")
            
            reasons.append(f"â¤ï¸ ×›×•×œ×œ {food_pref}")
            
            # ×‘×•× ×•×¡ ×¡×¤×¦×™×¤×™ ××”×¢××•×“×” snack_score
            if food_pref == "×—×˜×™×£" and product.get('snack_score', 0) > 0:
                snack_bonus = product.get('snack_score', 0)
                score += snack_bonus
                reasons.append(f"ğŸ¯ ×‘×•× ×•×¡ ×—×˜×™×£: +{snack_bonus}")
    
    # 6. ×¤×•×¤×•×œ×¨×™×•×ª
    score += product.get('popularity_score', 5)
    
    # 7. ××•×•×“× ×©×”××•×¦×¨ ×‘××œ××™
    if not product.get('in_stock', True):
        return 0, ["âŒ ××–×œ ××”××œ××™"]
    
    return score, reasons
