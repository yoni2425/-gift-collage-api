"""
 注 爪转 
Smart Recommendation Engine
"""

from typing import List, Dict, Tuple
from itertools import combinations
import csv
from tag_system import extract_tags_from_text, calculate_product_score

# ============================================================
# 驻拽爪转 注专
# ============================================================

def load_products_from_csv(csv_data: str) -> List[Dict]:
    """
    注 爪专 -CSV
    """
    import io
    products = []
    
    reader = csv.DictReader(io.StringIO(csv_data))
    for row in reader:
        # 专 驻住
        product = {
            'product_id': row.get('product_id', ''),
            'name': row.get('name', ''),
            'image_url': row.get('image_url', ''),
            'price': float(row.get('price', 0)),
            'height_cm': float(row.get('height_cm', 10)),
            'category': row.get('category', ''),
            'subcategory': row.get('subcategory', ''),
            'brand': row.get('brand', ''),
            'occasions': row.get('occasions', ''),
            'recipients': row.get('recipients', ''),
            'styles': row.get('styles', ''),
            'dietary': row.get('dietary', ''),
            'description': row.get('description', ''),
            'color_dominant': row.get('color_dominant', ''),
            'size_category': row.get('size_category', 'small'),
            'popularity_score': int(row.get('popularity_score', 5)),
            'in_stock': row.get('in_stock', 'TRUE').upper() == 'TRUE',
            'mishloach_manot_score': int(row.get('mishloach_manot_score', 0)),
            'purim_boost': int(row.get('purim_boost', 0)),
            'chanukah_boost': int(row.get('chanukah_boost', 0)),
            'snack_score': int(row.get('snack_score', 0))
        }
        products.append(product)
    
    return products


def score_all_products(products: List[Dict], user_text: str) -> List[Dict]:
    """
    砖 爪  爪专
    """
    # 抓 转转 拽住
    extracted_tags = extract_tags_from_text(user_text)
    
    scored_products = []
    for product in products:
        score, reasons = calculate_product_score(product, extracted_tags)
        
        if score > 0:  # 专拽 爪专 转!
            scored_products.append({
                **product,
                'match_score': score,
                'match_reasons': reasons,
                'extracted_tags': extracted_tags
            })
    
    #  驻 爪
    scored_products.sort(key=lambda x: x['match_score'], reverse=True)
    
    return scored_products


def build_balanced_basket(
    scored_products: List[Dict], 
    budget: float,
    target_size: int = None
) -> Dict:
    """
     专  注  拽专转
    """
    
    #   target_size, 砖 驻 转拽爪
    if target_size is None:
        if budget < 100:
            target_size = 3
        elif budget < 200:
            target_size = 5
        elif budget < 300:
            target_size = 7
        else:
            target_size = 10
    
    # 拽 拽专转
    by_category = {}
    for product in scored_products:
        cat = product['category']
        if cat not in by_category:
            by_category[cat] = []
        by_category[cat].append(product)
    
    #  专
    basket_products = []
    remaining_budget = budget * 0.77  # 77% 转拽爪 爪专
    categories_used = set()
    
    # 砖 1: 拽 转 爪专 注 爪  转专
    for product in scored_products[:target_size * 2]:  # 驻砖 驻
        if len(basket_products) >= target_size:
            break
        
        if product['price'] <= remaining_budget:
            # 注驻  拽专转
            if product['category'] not in categories_used or len(categories_used) >= 3:
                basket_products.append(product)
                remaining_budget -= product['price']
                categories_used.add(product['category'])
    
    # 砖 2: 砖  住专
    if len(basket_products) < target_size:
        for product in scored_products:
            if product not in basket_products and product['price'] <= remaining_budget:
                basket_products.append(product)
                remaining_budget -= product['price']
                
                if len(basket_products) >= target_size:
                    break
    
    # 砖 专 
    total_price = sum(p['price'] for p in basket_products)
    
    # 拽  转拽爪
    if total_price > budget:
        # 住 砖  转专
        basket_products = find_best_combination(scored_products, budget, target_size)
        total_price = sum(p['price'] for p in basket_products)
    
    # 住祝 拽专转 爪注
    categories = list(set(p['category'] for p in basket_products))
    colors = list(set(p['color_dominant'] for p in basket_products))
    
    return {
        'products': basket_products,
        'total_price': total_price,
        'budget': budget,
        'categories': categories,
        'colors': colors,
        'extracted_tags': basket_products[0]['extracted_tags'] if basket_products else {}
    }


def find_best_combination(
    scored_products: List[Dict],
    budget: float,
    target_size: int
) -> List[Dict]:
    """
    爪 砖 驻 砖 爪专 转 转拽爪
    """
    best_combo = []
    best_score = 0
    
    # 住 砖 砖
    for size in range(target_size, max(2, target_size - 2), -1):
        # 拽 专拽 转 -20  转专 专转
        candidates = scored_products[:20]
        
        for combo in combinations(candidates, size):
            combo_price = sum(p['price'] for p in combo)
            combo_score = sum(p['match_score'] for p in combo)
            
            if combo_price <= budget and combo_score > best_score:
                best_combo = list(combo)
                best_score = combo_score
    
    return best_combo if best_combo else scored_products[:target_size]


def recommend_basket(
    products: List[Dict],
    criteria: Dict
) -> Dict:
    """
    驻拽爪 专砖转 - 爪 注 专
    
    Args:
        products: 专砖转  爪专
        criteria: {
            'free_text': str,  # 拽住 驻砖 砖转砖
            'budget': float,   # 转拽爪
            'size': int        # 转 爪专 (驻爪)
        }
    
    Returns:
        {
            'products': [...],
            'total_price': float,
            'budget': float,
            'categories': [...],
            'colors': [...],
            'extracted_tags': {...}
        }
    """
    user_text = criteria.get('free_text', '')
    budget = criteria.get('budget', 200)
    target_size = criteria.get('size')
    
    # 专 爪专
    scored_products = score_all_products(products, user_text)
    
    if not scored_products:
        #   转转, 专 转 驻驻专 转专
        scored_products = sorted(
            products, 
            key=lambda x: x.get('popularity_score', 0), 
            reverse=True
        )
    
    #  专
    basket = build_balanced_basket(scored_products, budget, target_size)
    
    return basket


# ============================================================
# 驻拽爪转 /拽
# ============================================================

if __name__ == "__main__":
    #  砖砖
    sample_criteria = {
        'free_text': '砖 转 驻 注 驻',
        'budget': 150,
        'size': 6
    }
    
    print(" 注 爪转 !")
    print(f": {sample_criteria}")
